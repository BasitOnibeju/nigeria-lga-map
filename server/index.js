require("dotenv").config();const express=require("express");const {Pool}=require("pg");const cors=require("cors");const path=require("path");const pool=new Pool({connectionString:process.env.DATABASE_URL||"postgresql://postgres@localhost:5432/gis"});const app=express();app.use(cors());app.use(express.json());app.use(express.static(path.join(__dirname,"../web")));app.get("/api/ping",(req,res)=>res.json({ok:true}));app.get("/api/lgas",async(req,res)=>{try{const bbox=req.query.bbox;if(!bbox) return res.status(400).json({error:"bbox required"});const [minx,miny,maxx,maxy]=bbox.split(",").map(Number);const tolerance=parseFloat(req.query.tol)||0.0005;const sql=` SELECT ogc_fid AS id, name_2 AS lga_name, name_1 AS state_name, ST_AsGeoJSON(ST_Simplify(geom,$5,true)) AS geom FROM nigeria_lgas WHERE geom && ST_MakeEnvelope($1,$2,$3,$4,4326) LIMIT 2000; `;const vals=[minx,miny,maxx,maxy,tolerance];const {rows}=await pool.query(sql,vals);const features=rows.map(r=>({type:"Feature",properties:{id:r.id,lga_name:r.lga_name,state_name:r.state_name},geometry:JSON.parse(r.geom)}));res.json({type:"FeatureCollection",features});}catch(err){console.error(err);res.status(500).json({error:"server error",detail:err.message});}});const PORT=process.env.PORT||3000;app.listen(PORT,()=>console.log(`Server listening on ${PORT}`));
